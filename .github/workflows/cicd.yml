deploy:
  needs: build-test
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/master'

  steps:
  - name: Download artifact
    uses: actions/download-artifact@v4
    with:
      name: laravel-app
      path: ./deploy

  - name: Install SSH key
    uses: shimataro/ssh-key-action@v2
    with:
      key: ${{ secrets.SSH_PRIVATE_KEY }}
      known_hosts: ${{ secrets.KNOWN_HOSTS }}

  - name: Deploy to server via SSH
    run: |
      ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
        cd ~/laravel-d4rpl2c-kelompok9 || exit

        # Sync files to production
        sudo rsync -avz --delete \
          --exclude='.env' \
          --exclude='storage' \
          --exclude='.git' \
          --exclude='.github' \
          ./ /var/www/laravel-d4rpl2c-kelompok9/

        sudo chown -R www-data:www-data /var/www/laravel-d4rpl2c-kelompok9/storage
        sudo chown -R www-data:www-data /var/www/laravel-d4rpl2c-kelompok9/bootstrap/cache
        sudo chmod -R 775 /var/www/laravel-d4rpl2c-kelompok9/storage
        sudo chmod -R 775 /var/www/laravel-d4rpl2c-kelompok9/bootstrap/cache

        cd /var/www/laravel-d4rpl2c-kelompok9 || exit

        sudo -u www-data composer install --optimize-autoloader --no-dev
        sudo -u www-data php artisan config:cache
        sudo -u www-data php artisan migrate --force
        echo "Deployment selesai!"
      EOF
